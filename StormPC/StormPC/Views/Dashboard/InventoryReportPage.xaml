<?xml version="1.0" encoding="utf-8" ?>
<Page
    x:Class="StormPC.Views.Dashboard.InventoryReportPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:lvc="using:LiveChartsCore.SkiaSharpView.WinUI"
    xmlns:lvcore="using:LiveChartsCore"
    xmlns:vm="using:StormPC.ViewModels.Dashboard"
    xmlns:helpers="using:StormPC.Helpers"
    xmlns:coreHelpers="using:StormPC.Core.Helpers"
    xmlns:controls="using:Microsoft.UI.Xaml.Controls"
    xmlns:winui="using:Microsoft.UI.Xaml"
    xmlns:grid="using:CommunityToolkit.WinUI.UI.Controls"
    mc:Ignorable="d">

    <Page.Resources>
        <helpers:NumberFormatConverter x:Key="NumberFormatConverter"/>
        <helpers:CurrencyConverter x:Key="CurrencyConverter"/>
        <helpers:PercentageConverter x:Key="PercentageConverter"/>
        <helpers:DateTimeConverter x:Key="DateTimeConverter"/>
        <helpers:PreviousPageConverter x:Key="PreviousPageConverter"/>
        <helpers:NextPageConverter x:Key="NextPageConverter"/>
        <Style x:Key="CardStyle" TargetType="Grid">
            <Setter Property="Background" Value="{ThemeResource CardBackgroundFillColorDefaultBrush}"/>
            <Setter Property="BorderBrush" Value="{ThemeResource CardStrokeColorDefaultBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="16"/>
            <Setter Property="Margin" Value="8"/>
        </Style>
    </Page.Resources>

    <ScrollViewer>
        <Grid Margin="20">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Header -->
            <Grid Grid.Row="0" Margin="0,0,0,20">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Text="Báo cáo kho hàng" 
                         Style="{StaticResource TitleTextBlockStyle}"
                         VerticalAlignment="Center"/>

                <CalendarDatePicker Grid.Column="1" 
                                  Header="Từ ngày"
                                  Date="{x:Bind ViewModel.StartDate, Mode=TwoWay}"
                                  Margin="10,0"/>

                <CalendarDatePicker Grid.Column="2" 
                                  Header="Đến ngày"
                                  Date="{x:Bind ViewModel.EndDate, Mode=TwoWay}"
                                  Margin="10,0"/>

                <Button Grid.Column="3"
                        Content="Làm mới"
                        Command="{x:Bind ViewModel.RefreshCommand}"
                        Style="{StaticResource AccentButtonStyle}"
                        Margin="10,0"/>
            </Grid>

            <!-- KPI Cards -->
            <Grid Grid.Row="1" Margin="0,0,0,20">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <Grid Grid.Column="0" Style="{StaticResource CardStyle}" Margin="0,0,10,0">
                    <StackPanel Margin="10">
                        <TextBlock Text="Tổng sản phẩm" Style="{StaticResource CaptionTextBlockStyle}"/>
                        <TextBlock Text="{x:Bind ViewModel.TotalProducts, Mode=OneWay, Converter={StaticResource NumberFormatConverter}}" 
                                 Style="{StaticResource SubtitleTextBlockStyle}"/>
                    </StackPanel>
                </Grid>

                <Grid Grid.Column="1" Style="{StaticResource CardStyle}" Margin="0,0,10,0">
                    <StackPanel Margin="10">
                        <TextBlock Text="Tổng tồn kho" Style="{StaticResource CaptionTextBlockStyle}"/>
                        <TextBlock Text="{x:Bind ViewModel.TotalStock, Mode=OneWay, Converter={StaticResource NumberFormatConverter}}" 
                                 Style="{StaticResource SubtitleTextBlockStyle}"/>
                    </StackPanel>
                </Grid>

                <Grid Grid.Column="2" Style="{StaticResource CardStyle}" Margin="0,0,10,0">
                    <StackPanel Margin="10">
                        <TextBlock Text="Giá trị tồn kho" Style="{StaticResource CaptionTextBlockStyle}"/>
                        <TextBlock Text="{x:Bind ViewModel.TotalValue, Mode=OneWay, Converter={StaticResource CurrencyConverter}}" 
                                 Style="{StaticResource SubtitleTextBlockStyle}"/>
                    </StackPanel>
                </Grid>

                <Grid Grid.Column="3" Style="{StaticResource CardStyle}" Margin="0,0,10,0">
                    <StackPanel Margin="10">
                        <TextBlock Text="Giá trị TB/SP" Style="{StaticResource CaptionTextBlockStyle}"/>
                        <TextBlock Text="{x:Bind ViewModel.AverageStockValue, Mode=OneWay, Converter={StaticResource CurrencyConverter}}" 
                                 Style="{StaticResource SubtitleTextBlockStyle}"/>
                    </StackPanel>
                </Grid>

                <Grid Grid.Column="4" Style="{StaticResource CardStyle}" Margin="0,0,10,0">
                    <StackPanel Margin="10">
                        <TextBlock Text="Vòng quay tồn kho" Style="{StaticResource CaptionTextBlockStyle}"/>
                        <TextBlock Text="{x:Bind ViewModel.StockTurnoverRate, Mode=OneWay, Converter={StaticResource PercentageConverter}}" 
                                 Style="{StaticResource SubtitleTextBlockStyle}"/>
                    </StackPanel>
                </Grid>

                <Grid Grid.Column="5" Style="{StaticResource CardStyle}" Margin="0,0,10,0">
                    <StackPanel Margin="10">
                        <TextBlock Text="SP sắp hết" Style="{StaticResource CaptionTextBlockStyle}"/>
                        <TextBlock Text="{x:Bind ViewModel.LowStockProducts, Mode=OneWay, Converter={StaticResource NumberFormatConverter}}" 
                                 Style="{StaticResource SubtitleTextBlockStyle}"/>
                    </StackPanel>
                </Grid>

                <Grid Grid.Column="6" Style="{StaticResource CardStyle}" Margin="0,0,10,0">
                    <StackPanel Margin="10">
                        <TextBlock Text="Đơn hàng hôm nay" Style="{StaticResource CaptionTextBlockStyle}"/>
                        <TextBlock Text="{x:Bind ViewModel.TodayOrderCount, Mode=OneWay, Converter={StaticResource NumberFormatConverter}}" 
                                 Style="{StaticResource SubtitleTextBlockStyle}"/>
                    </StackPanel>
                </Grid>

                <Grid Grid.Column="7" Style="{StaticResource CardStyle}">
                    <StackPanel Margin="10">
                        <TextBlock Text="Doanh thu hôm nay" Style="{StaticResource CaptionTextBlockStyle}"/>
                        <TextBlock Text="{x:Bind ViewModel.TodayRevenue, Mode=OneWay, Converter={StaticResource CurrencyConverter}}" 
                                 Style="{StaticResource SubtitleTextBlockStyle}"/>
                    </StackPanel>
                </Grid>
            </Grid>

            <!-- Charts Grid -->
            <Grid Grid.Row="2" Margin="0,0,0,20">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Stock Trend Chart -->
                <Grid Grid.Column="0" Grid.Row="0" Style="{StaticResource CardStyle}" Margin="0,0,10,10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="300"/>
                    </Grid.RowDefinitions>

                    <TextBlock Text="Xu hướng tồn kho" 
                             Style="{StaticResource SubtitleTextBlockStyle}"
                             Margin="0,0,0,10"/>

                    <lvc:CartesianChart Grid.Row="1"
                        Series="{x:Bind ViewModel.StockTrendSeries, Mode=OneWay}"
                        XAxes="{x:Bind ViewModel.StockTrendXAxes, Mode=OneWay}"
                        YAxes="{x:Bind ViewModel.StockTrendYAxes, Mode=OneWay}"/>
                </Grid>

                <!-- Top Selling Products Chart -->
                <Grid Grid.Column="1" Grid.Row="0" Style="{StaticResource CardStyle}" Margin="0,0,0,10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="300"/>
                    </Grid.RowDefinitions>

                    <TextBlock Text="Top 5 sản phẩm bán chạy" 
                             Style="{StaticResource SubtitleTextBlockStyle}"
                             Margin="0,0,0,10"/>

                    <lvc:CartesianChart Grid.Row="1"
                        Series="{x:Bind ViewModel.TopSellersSeries, Mode=OneWay}"
                        XAxes="{x:Bind ViewModel.TopSellersXAxes, Mode=OneWay}"
                        YAxes="{x:Bind ViewModel.TopSellersYAxes, Mode=OneWay}"/>
                </Grid>

                <!-- Category Distribution Chart -->
                <Grid Grid.Column="0" Grid.Row="1" Style="{StaticResource CardStyle}" Margin="0,0,10,10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="300"/>
                    </Grid.RowDefinitions>

                    <TextBlock Text="Phân bố theo danh mục" 
                             Style="{StaticResource SubtitleTextBlockStyle}"
                             Margin="0,0,0,10"/>

                    <lvc:CartesianChart Grid.Row="1"
                        Series="{x:Bind ViewModel.CategoryDistributionSeries, Mode=OneWay}"
                        XAxes="{x:Bind ViewModel.CategoryXAxes, Mode=OneWay}"
                        YAxes="{x:Bind ViewModel.CategoryYAxes, Mode=OneWay}"/>
                </Grid>

                <!-- Brand Distribution Chart -->
                <Grid Grid.Column="1" Grid.Row="1" Style="{StaticResource CardStyle}" Margin="0,0,0,10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="300"/>
                    </Grid.RowDefinitions>

                    <TextBlock Text="Phân bố theo thương hiệu" 
                             Style="{StaticResource SubtitleTextBlockStyle}"
                             Margin="0,0,0,10"/>

                    <lvc:CartesianChart Grid.Row="1"
                        Series="{x:Bind ViewModel.BrandDistributionSeries, Mode=OneWay}"
                        XAxes="{x:Bind ViewModel.BrandXAxes, Mode=OneWay}"
                        YAxes="{x:Bind ViewModel.BrandYAxes, Mode=OneWay}"/>
                </Grid>

                <!-- Stock Aging Chart -->
                <Grid Grid.Column="0" Grid.Row="2" Style="{StaticResource CardStyle}" Margin="0,0,10,10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="300"/>
                    </Grid.RowDefinitions>

                    <TextBlock Text="Phân tích tuổi tồn kho" 
                             Style="{StaticResource SubtitleTextBlockStyle}"
                             Margin="0,0,0,10"/>

                    <lvc:CartesianChart Grid.Row="1"
                        Series="{x:Bind ViewModel.StockAgingSeries, Mode=OneWay}"
                        XAxes="{x:Bind ViewModel.AgingXAxes, Mode=OneWay}"
                        YAxes="{x:Bind ViewModel.AgingYAxes, Mode=OneWay}"/>
                </Grid>

                <!-- Top Selling Products Table -->
                <Grid Grid.Column="1" Grid.Row="2" Style="{StaticResource CardStyle}" Margin="0,0,0,10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="300"/>
                    </Grid.RowDefinitions>

                    <TextBlock Text="Chi tiết top bán chạy" 
                             Style="{StaticResource SubtitleTextBlockStyle}"
                             Margin="0,0,0,10"/>

                    <grid:DataGrid Grid.Row="1"
                         ItemsSource="{x:Bind ViewModel.TopSellingProducts, Mode=OneWay}"
                         AutoGenerateColumns="False"
                         IsReadOnly="True"
                         HorizontalAlignment="Stretch"
                         HorizontalScrollBarVisibility="Auto">
                        <grid:DataGrid.Columns>
                            <grid:DataGridTextColumn Header="SKU" Binding="{Binding SKU}" Width="*"/>
                            <grid:DataGridTextColumn Header="Tên sản phẩm" Binding="{Binding ModelName}" Width="2*"/>
                            <grid:DataGridTextColumn Header="Danh mục" Binding="{Binding CategoryName}" Width="*"/>
                            <grid:DataGridTextColumn Header="Thương hiệu" Binding="{Binding BrandName}" Width="*"/>
                            <grid:DataGridTextColumn Header="Số lượng bán" Binding="{Binding QuantitySold, Converter={StaticResource NumberFormatConverter}}" Width="*"/>
                            <grid:DataGridTextColumn Header="Doanh thu" Binding="{Binding Revenue, Converter={StaticResource CurrencyConverter}}" Width="*"/>
                        </grid:DataGrid.Columns>
                    </grid:DataGrid>
                </Grid>
            </Grid>

            <!-- Aged Inventories Table -->
            <Grid Grid.Row="3" Style="{StaticResource CardStyle}" Margin="0,0,0,20">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="300"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <TextBlock Text="Phân tích tuổi tồn kho" 
                         Style="{StaticResource SubtitleTextBlockStyle}"
                         Margin="0,0,0,10"/>

                <grid:DataGrid Grid.Row="1"
                         ItemsSource="{x:Bind ViewModel.AgedInventoriesPagedItems, Mode=OneWay}"
                         AutoGenerateColumns="False"
                         IsReadOnly="True"
                         HorizontalAlignment="Stretch"
                         HorizontalScrollBarVisibility="Auto"
                         Margin="0,10,0,10">
                    <grid:DataGrid.Columns>
                        <grid:DataGridTextColumn Header="SKU" Binding="{Binding SKU}" Width="*"/>
                        <grid:DataGridTextColumn Header="Tên sản phẩm" Binding="{Binding ModelName}" Width="2*"/>
                        <grid:DataGridTextColumn Header="Danh mục" Binding="{Binding CategoryName}" Width="*"/>
                        <grid:DataGridTextColumn Header="Thương hiệu" Binding="{Binding BrandName}" Width="*"/>
                        <grid:DataGridTextColumn Header="Tồn kho" Binding="{Binding StockQuantity, Converter={StaticResource NumberFormatConverter}}" Width="*"/>
                        <grid:DataGridTextColumn Header="Giá trị" Binding="{Binding StockValue, Converter={StaticResource CurrencyConverter}}" Width="*"/>
                        <grid:DataGridTextColumn Header="Số ngày tồn" Binding="{Binding DaysInStock, Converter={StaticResource NumberFormatConverter}}" Width="*"/>
                        <grid:DataGridTextColumn Header="Lần bán cuối" Binding="{Binding LastSoldDate, Converter={StaticResource DateTimeConverter}}" Width="*"/>
                    </grid:DataGrid.Columns>
                </grid:DataGrid>

                <!-- Phân trang cho bảng thời gian tồn kho -->
                <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,0,0,10">
                    <Button Content="&lt;" 
                            Command="{x:Bind ViewModel.PreviousAgedInventoriesPageCommand}"
                            IsEnabled="{x:Bind ViewModel.CanGoToPreviousAgedInventoriesPage, Mode=OneWay}"/>
                    <TextBlock Text="{x:Bind ViewModel.AgedInventoriesCurrentPage, Mode=OneWay}" 
                             VerticalAlignment="Center" 
                             Margin="10,0"/>
                    <TextBlock Text="/" VerticalAlignment="Center"/>
                    <TextBlock Text="{x:Bind ViewModel.AgedInventoriesTotalPages, Mode=OneWay}" 
                             VerticalAlignment="Center" 
                             Margin="10,0"/>
                    <Button Content="&gt;" 
                            Command="{x:Bind ViewModel.NextAgedInventoriesPageCommand}"
                            IsEnabled="{x:Bind ViewModel.CanGoToNextAgedInventoriesPage, Mode=OneWay}"/>
                </StackPanel>
            </Grid>

            <!-- Restock Suggestions -->
            <Grid Grid.Row="4">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <TextBlock Text="Đề xuất nhập hàng" 
                         Style="{StaticResource SubtitleTextBlockStyle}"
                         Margin="0,0,0,10"/>

                <grid:DataGrid Grid.Row="1"
                         ItemsSource="{x:Bind ViewModel.RestockSuggestionsPagedItems, Mode=OneWay}"
                         AutoGenerateColumns="False"
                         IsReadOnly="True"
                         HorizontalAlignment="Stretch"
                         HorizontalScrollBarVisibility="Auto"
                         Margin="0,0,0,10">
                    <grid:DataGrid.Columns>
                        <grid:DataGridTextColumn Header="SKU" Binding="{Binding SKU}" Width="*"/>
                        <grid:DataGridTextColumn Header="Tên sản phẩm" Binding="{Binding ModelName}" Width="2*"/>
                        <grid:DataGridTextColumn Header="Danh mục" Binding="{Binding CategoryName}" Width="*"/>
                        <grid:DataGridTextColumn Header="Thương hiệu" Binding="{Binding BrandName}" Width="*"/>
                        <grid:DataGridTextColumn Header="Tồn kho" Binding="{Binding CurrentStock, Converter={StaticResource NumberFormatConverter}}" Width="*"/>
                        <grid:DataGridTextColumn Header="TB bán/tháng" Binding="{Binding AverageMonthlySales, Converter={StaticResource NumberFormatConverter}}" Width="*"/>
                        <grid:DataGridTextColumn Header="Đề xuất nhập" Binding="{Binding SuggestedReorderQuantity, Converter={StaticResource NumberFormatConverter}}" Width="*"/>
                        <grid:DataGridTextColumn Header="Giá trị nhập" Binding="{Binding EstimatedValue, Converter={StaticResource CurrencyConverter}}" Width="*"/>
                    </grid:DataGrid.Columns>
                </grid:DataGrid>

                <!-- Phân trang cho bảng đề xuất nhập hàng -->
                <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,0,0,10">
                    <Button Content="&lt;" 
                            Command="{x:Bind ViewModel.PreviousRestockSuggestionsPageCommand}"
                            IsEnabled="{x:Bind ViewModel.CanGoToPreviousRestockSuggestionsPage, Mode=OneWay}"/>
                    <TextBlock Text="{x:Bind ViewModel.RestockSuggestionsCurrentPage, Mode=OneWay}" 
                             VerticalAlignment="Center" 
                             Margin="10,0"/>
                    <TextBlock Text="/" VerticalAlignment="Center"/>
                    <TextBlock Text="{x:Bind ViewModel.RestockSuggestionsTotalPages, Mode=OneWay}" 
                             VerticalAlignment="Center" 
                             Margin="10,0"/>
                    <Button Content="&gt;" 
                            Command="{x:Bind ViewModel.NextRestockSuggestionsPageCommand}"
                            IsEnabled="{x:Bind ViewModel.CanGoToNextRestockSuggestionsPage, Mode=OneWay}"/>
                </StackPanel>
            </Grid>
        </Grid>
    </ScrollViewer>
</Page> 